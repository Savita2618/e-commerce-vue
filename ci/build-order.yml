---
build-order-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    SERVICE_NAME: order-service
    SERVICE_PATH: services/order-service
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER
      --password-stdin $CI_REGISTRY
    - export PROJECT_NAME_LOWER=$(echo $CI_PROJECT_PATH | tr '[:upper:]'
      '[:lower:]')
    - echo "ðŸ“¦ === BUILD ORDER SERVICE ==="
    - echo "Variables d'environnement:"
    - echo "- Image: $CI_REGISTRY/$PROJECT_NAME_LOWER/$SERVICE_NAME:$CI_PIPELINE_ID"
    - echo "- Registry: $CI_REGISTRY"
    - echo "- Branch: $CI_COMMIT_BRANCH"
    - echo "- Commit: $CI_COMMIT_SHORT_SHA"
  script:
    - echo "ðŸ“¦ Build optimisÃ© order-service avec intÃ©grations services..."
    - cd services/order-service
    - export PROJECT_NAME_LOWER=$(echo $CI_PROJECT_PATH | tr '[:upper:]'
      '[:lower:]')
    - docker build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from
      $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest --tag
      $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:$CI_PIPELINE_ID --tag
      $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest --target production
      --label "service.type=order-management" --label
      "service.integrations=product-service,auth-service" --label
      "ci.pipeline.id=$CI_PIPELINE_ID" --label
      "ci.commit.sha=$CI_COMMIT_SHORT_SHA" --label "ci.branch=$CI_COMMIT_BRANCH"
      --label "project=esgi-ecommerce" .
    - docker push $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:$CI_PIPELINE_ID
    - docker push $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest
    - echo "âœ… Image order-service buildÃ©e"
    - docker run --rm --name order-test-build -e NODE_ENV=test -e PORT=3003
      $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:$CI_PIPELINE_ID node
      --version || echo "Test completed"
    - echo "âœ… Order-service build terminÃ© avec succÃ¨s"
  after_script:
    - docker system prune -f
  cache:
    key: $CI_COMMIT_REF_SLUG-order
    paths:
      - .docker/
  artifacts:
    when: always
    paths:
      - services/order-service/package.json
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
