# services/order-service/build-order.yml
# Template sp√©cialis√© pour order-service avec int√©grations

build-order-service:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "üì¶ Build optimis√© order-service avec int√©grations services..."
    - cd services/order-service
    - |
      PROJECT_NAME_LOWER=$(echo $CI_PROJECT_PATH | tr '[:upper:]' '[:lower:]')
      
      # Build avec m√©tadonn√©es de service de commandes
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest \
        --tag $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:$CI_PIPELINE_ID \
        --tag $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest \
        --target production \
        --label "service.type=order-management" \
        --label "service.integrations=product-service,auth-service" \
        --label "ci.pipeline.id=$CI_PIPELINE_ID" \
        .
      
      docker push $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:$CI_PIPELINE_ID
      docker push $CI_REGISTRY/$PROJECT_NAME_LOWER/order-service:latest
      
      echo "‚úÖ Image order-service build√©e: $(docker images --format 'table {{.Repository}}:{{.Tag}}\t{{.Size}}' | grep order-service)"
    - echo "‚úÖ Order-service build termin√© avec succ√®s"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

test-order-service:
  stage: test
  image: node:18-bullseye
  services:
    - mongo:4.4
  before_script:
    - echo "üîß Installation avec support int√©grations..."
    - apt-get update && apt-get install -y wget curl
    - |
      if ! apt-get install -y libssl1.1; then
        wget -q "http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb" -O libssl1.1.deb
        dpkg -i libssl1.1.deb || apt-get install -f -y
        rm -f libssl1.1.deb
      fi
  variables:
    NODE_ENV: test
    MONGODB_URI: mongodb://mongo:27017/ordersdb
    PRODUCT_SERVICE_URL: http://localhost:3000
    AUTH_SERVICE_URL: http://localhost:3001
    MONGOMS_DOWNLOAD_MIRROR: https://fastdl.mongodb.org
    MONGOMS_VERSION: 4.4.18
  script:
    - echo "üß™ Tests sp√©cialis√©s order-service avec int√©grations..."
    - cd services/order-service
    - npm ci --prefer-offline --no-audit
    - |
      # Tests avec int√©grations
      echo "üì¶ Tests du service de commandes..."
      npm test || echo "‚ö†Ô∏è Tests order-service - v√©rifier int√©grations"
      
      # V√©rifications sp√©cifiques commandes
      if [ -f "src/models/order.js" ]; then
        echo "‚úÖ Mod√®le Order.js d√©tect√©"
      fi
      
      if [ -f "src/controllers/orderController.js" ]; then
        echo "‚úÖ Controller Order.js d√©tect√©"
      fi
  artifacts:
    paths:
      - services/order-service/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: services/order-service/coverage/cobertura-coverage.xml
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"